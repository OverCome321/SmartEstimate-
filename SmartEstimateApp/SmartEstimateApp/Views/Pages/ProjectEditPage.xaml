<Page x:Class="SmartEstimateApp.Views.Pages.ProjectEditPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:SmartEstimateApp.Views.Pages"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:converters="clr-namespace:SmartEstimateApp.Converters"
      mc:Ignorable="d" 
      d:DesignHeight="1200" d:DesignWidth="1000"
      Title="Редактировать проект">
    
    <Grid Background="{StaticResource AppleBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{StaticResource AppleCardBackgroundBrush}" 
                BorderBrush="{StaticResource AppleBorderBrush}" BorderThickness="0,0,0,1"
                Padding="24">
            <Grid VerticalAlignment="Center">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" 
                        Style="{StaticResource AppleCloseButtonStyle}" 
                        Command="{Binding CancelCommand}"
                        VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="Close" Width="20" Height="20"/>
                </Button>

                <!-- Заголовок -->
                <StackPanel Grid.Column="1" Orientation="Vertical" 
                            VerticalAlignment="Center" 
                            Margin="24,0,0,0">
                    <!-- Отступ слева от крестика -->
                    <TextBlock Text="Проект и сметы" FontFamily="{StaticResource AppleFont}" 
                               FontWeight="SemiBold" FontSize="28" 
                               Foreground="{StaticResource AppleTextPrimaryBrush}"/>
                    <TextBlock Text="Заполните информацию о проекте и добавьте необходимые сметы" 
                               FontFamily="{StaticResource AppleFont}" FontSize="16"
                               Foreground="{StaticResource AppleTextSecondaryBrush}"
                               Margin="0,8,0,0"/>
                </StackPanel>

                <!-- Кнопка Сохранить -->
                <Button Grid.Column="2" Content="Сохранить" 
                        Style="{StaticResource ApplePrimaryButton}"
                        Command="{Binding SaveProjectCommand}" Width="100"
                        VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" 
                      HorizontalScrollBarVisibility="Disabled" Padding="32,24">
            <StackPanel>
                <Border Style="{StaticResource DashboardProjectCardAnimated}">
                    <StackPanel>
                        <TextBlock Text="Информация о проекте" FontFamily="{StaticResource AppleFont}" 
                                   FontWeight="SemiBold" FontSize="18" 
                                   Foreground="{StaticResource AppleTextPrimaryBrush}"
                                   Margin="0,0,0,20"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="24"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Название проекта" Style="{StaticResource LabelStyle}"/>
                                <TextBox Text="{Binding Project.Name, UpdateSourceTrigger=PropertyChanged}" 
                                        Style="{StaticResource ProjectInputField}"
                                        materialDesign:HintAssist.HintOpacity="0.5"
                                         materialDesign:HintAssist.Hint="Введите название проекта"/>
                                <TextBlock Text="Клиент" Style="{StaticResource LabelStyle}" Margin="0,16,0,8"/>
                                <ComboBox ItemsSource="{Binding Clients}" 
                                      SelectedItem="{Binding SelectedClient, UpdateSourceTrigger=PropertyChanged}"
                                      DisplayMemberPath="Name"
                                      Style="{StaticResource AppleComboBoxStyle}"
                                      materialDesign:HintAssist.Hint="Выберите клиента"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Описание" Style="{StaticResource LabelStyle}"/>
                                <TextBox Text="{Binding Project.Description, UpdateSourceTrigger=PropertyChanged}" 
                                        Style="{StaticResource ProjectInputField}"
                                        materialDesign:HintAssist.HintOpacity="0.5"
                                         materialDesign:HintAssist.Hint="Введите описание проекта"
                                         TextWrapping="Wrap" AcceptsReturn="True"
                                         Height="100" VerticalContentAlignment="Top" Padding="12"/>
                                <TextBlock Text="Статус проекта" Style="{StaticResource LabelStyle}" Margin="0,16,0,8"/>
                                <ComboBox ItemsSource="{Binding ProjectStatusOptions}" 
                                          DisplayMemberPath="Name"
                                          SelectedValuePath="Id"
                                          SelectedValue="{Binding Project.Status, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{StaticResource AppleComboBoxStyle}"
                                          materialDesign:HintAssist.Hint="Выберите статус"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 2. СМЕТЫ ПРОЕКТА -->
                <Border Style="{StaticResource DashboardProjectCardAnimated}">
                    <StackPanel>
                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="Сметы проекта" FontFamily="{StaticResource AppleFont}" 
                                       FontWeight="SemiBold" FontSize="18" 
                                       Foreground="{StaticResource AppleTextPrimaryBrush}" VerticalAlignment="Center"/>
                            <Button Grid.Column="1" Content="Добавить смету" Style="{StaticResource AppleSecondaryButton}"
                                    Command="{Binding AddEstimateCommand}"/>
                        </Grid>
                        <ItemsControl ItemsSource="{Binding Project.Estimates}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Expander Style="{StaticResource EstimateExpanderStyle}">
                                        <Expander.Header>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" FontFamily="{StaticResource AppleFont}" FontWeight="SemiBold" FontSize="16"
                                                           Foreground="{StaticResource AppleTextPrimaryBrush}">
                                                    <Run Text="Смета №"/>
                                                    <Run Text="{Binding Number}"/>
                                                </TextBlock>
                                                <TextBlock Grid.Column="1" Text="{Binding Status}" Foreground="{StaticResource AppleSuccessBrush}"
                                                           FontWeight="Medium" HorizontalAlignment="Left" Margin="16,0,0,0" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Column="2" Text="{Binding TotalAmount, StringFormat='{}{0:C}'}" 
                                                           FontWeight="SemiBold" FontSize="16" Foreground="{StaticResource AppleTextPrimaryBrush}"
                                                           VerticalAlignment="Center" Margin="0,0,24,0"/>
                                                <Button Grid.Column="3" Style="{StaticResource MaterialDesignIconButton}"
                                                        Command="{Binding DataContext.RemoveEstimateCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                        CommandParameter="{Binding}">
                                                    <materialDesign:PackIcon Kind="DeleteOutline" Foreground="{StaticResource AppleErrorBrush}"/>
                                                </Button>
                                            </Grid>
                                        </Expander.Header>
                                        <StackPanel>
                                            <Grid Margin="0,0,0,24">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="24"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="24"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Действительна до" Style="{StaticResource LabelStyle}"/>
                                                    <DatePicker SelectedDate="{Binding ValidUntil}" Style="{StaticResource AppleDatePickerStyle}"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="Скидка, %" Style="{StaticResource LabelStyle}"/>
                                                    <TextBox Text="{Binding DiscountRate, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ProjectInputField}"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="4">
                                                    <TextBlock Text="Валюта" Style="{StaticResource LabelStyle}"/>
                                                    <ComboBox ItemsSource="{Binding DataContext.Currencies, RelativeSource={RelativeSource AncestorType=Page}}" 
                                                              SelectedItem="{Binding Currency}" Style="{StaticResource AppleComboBoxStyle}"/>
                                                </StackPanel>
                                            </Grid>
                                            <Grid Margin="0,0,0,12">
                                                <TextBlock Text="Позиции сметы" FontFamily="{StaticResource AppleFont}" 
                                                           FontWeight="SemiBold" FontSize="16" Foreground="{StaticResource AppleTextPrimaryBrush}"/>
                                                <Button Content="Добавить позицию" Style="{StaticResource AppleSecondaryButton}" HorizontalAlignment="Right"
                                                        Command="{Binding DataContext.AddEstimateItemCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                            <DataGrid ItemsSource="{Binding Items}"
                                                      Style="{StaticResource AppleDataGridStyle}"
                                                      ColumnHeaderStyle="{StaticResource AppleDataGridColumnHeaderStyle}"
                                                      CellStyle="{StaticResource AppleDataGridCellStyle}">
                                                <DataGrid.Columns>
                                                    <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="3*"/>
                                                    <DataGridTextColumn Header="Кол-во" Binding="{Binding Quantity, StringFormat=N2}" Width="*"/>
                                                    <DataGridTextColumn Header="Цена за ед." Binding="{Binding UnitPrice, StringFormat=N2}" Width="*"/>
                                                    <DataGridTextColumn Header="Сумма" Binding="{Binding TotalPrice, StringFormat=N2}" Width="*" IsReadOnly="True"/>
                                                    <DataGridTemplateColumn Width="Auto">
                                                        <DataGridTemplateColumn.CellTemplate>
                                                            <DataTemplate>
                                                                <Button Style="{StaticResource MaterialDesignIconButton}"
                                                                        Command="{Binding DataContext.RemoveEstimateItemCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                                        CommandParameter="{Binding}">
                                                                    <materialDesign:PackIcon Kind="Close" Width="16" Height="16" Foreground="{StaticResource AppleTextSecondaryBrush}"/>
                                                                </Button>
                                                            </DataTemplate>
                                                        </DataGridTemplateColumn.CellTemplate>
                                                    </DataGridTemplateColumn>
                                                </DataGrid.Columns>
                                            </DataGrid>
                                        </StackPanel>
                                    </Expander>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        <TextBlock Text="В этом проекте еще нет ни одной сметы. Нажмите 'Добавить смету', чтобы начать."
                               Style="{StaticResource PlaceholderTextStyle}"
                               Visibility="{Binding NoEstimates, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>